#!/bin/bash
# agent-handoff - Transfer context between panes with smart formatting
# Usage: agent-handoff (interactive) or agent-handoff <source> <target>
set -e

# Source shared utilities
source "$(dirname "$0")/agent-common.sh"

SESSION_NAME=$(get_session_name)

# Content source selection menu
select_content_source() {
    local clipboard_content="$1"

    # Create preview (first 50 chars, single line)
    local preview="${clipboard_content:0:50}"
    preview=$(echo "$preview" | tr '\n' ' ' | sed 's/[[:space:]]\+/ /g')
    local len=${#clipboard_content}

    local menu=""
    menu+="CLIPBOARD|[CLIPBOARD] \"${preview}...\" (${len}c)"$'\n'
    menu+="PANE|[PANE] Last 50 lines from current pane"$'\n'
    menu+="CANCEL|[CANCEL] Cancel handoff"

    local selection
    selection=$(echo -e "$menu" | fzf \
        --height=30% \
        --layout=reverse \
        --border=rounded \
        --prompt="Send what? > " \
        --header="HANDOFF - Select content source (? help, ESC cancel)" \
        --delimiter='|' \
        --with-nth=2 \
        --no-preview \
        --bind='esc:abort' \
        --bind='?:execute(~/.local/bin/agent-help)' \
        --expect='esc') || true

    # Handle escape
    local first_line=$(echo "$selection" | head -1)
    if [[ "$first_line" == "esc" ]] || [[ -z "$selection" ]]; then
        echo "CANCEL"
        return
    fi

    echo "$selection" | tail -1 | cut -d'|' -f1
}

# Capture pane content (last N non-empty lines, strip ANSI)
capture_pane_content() {
    local pane_id="$1"
    local lines="${2:-50}"

    tmux capture-pane -p -t "$pane_id" 2>/dev/null | \
        sed 's/\x1b\[[0-9;]*m//g' | \
        grep -v '^[[:space:]]*$' | \
        tail -"$lines"
}

show_usage() {
    cat << 'EOF'
agent-handoff - Transfer context between panes

USAGE:
    agent-handoff              Interactive mode (pick source and target)
    agent-handoff <src> <dst>  Direct handoff between panes

ARGUMENTS:
    <src>   Source pane (index or name like PLAN, WORK, REVIEW)
    <dst>   Target pane (index or name like PLAN, WORK, REVIEW)

EXAMPLES:
    agent-handoff              # Interactive picker
    agent-handoff PLAN WORK    # Transfer from PLAN to WORK
    agent-handoff 0 1          # Transfer from pane 0 to pane 1

HANDOFF TEMPLATES:
    PLAN -> WORK    "Here's the plan to implement:"
    WORK -> REVIEW  "Please review this implementation:"
    REVIEW -> WORK  "Review feedback to address:"
    REVIEW -> PLAN  "Issues found that need re-planning:"
EOF
}

# Check if fzf is available
check_fzf() {
    if ! command -v fzf &> /dev/null; then
        echo -e "${RED}Error: fzf is required for interactive mode${NC}"
        echo "Install with: brew install fzf"
        exit 1
    fi
}

# Get list of panes with their info
get_panes() {
    tmux list-panes -t "$SESSION_NAME" -F "#{pane_id}|#{pane_index}|#{@role}|#{pane_title}" 2>/dev/null
}

# Get handoff template based on source -> target roles
get_handoff_template() {
    local from_role="$1"
    local to_role="$2"

    # Handle clipboard/selection source
    if [[ "$from_role" == "selection" || "$from_role" == "clipboard" ]]; then
        case "$to_role" in
            PLAN*) echo "Here's some context to consider for planning:" ;;
            WORK*) echo "Here's content to work with:" ;;
            REVIEW*) echo "Please review this:" ;;
            *) echo "Context:" ;;
        esac
        return
    fi

    case "${from_role}_to_${to_role}" in
        PLAN*_to_WORK*)
            echo "Here's the plan to implement:"
            ;;
        WORK*_to_REVIEW*)
            echo "Please review this implementation:"
            ;;
        REVIEW*_to_WORK*)
            echo "Review feedback to address:"
            ;;
        REVIEW*_to_PLAN*)
            echo "Issues found that need re-planning:"
            ;;
        *)
            echo "Context from ${from_role:-pane}:"
            ;;
    esac
}

# Resolve pane name/index to pane ID
resolve_pane() {
    local target="$1"
    local panes=$(get_panes)

    # Try by index first
    if [[ "$target" =~ ^[0-9]+$ ]]; then
        local match=$(echo "$panes" | awk -F'|' -v idx="$target" '$2 == idx {print $1; exit}')
        if [ -n "$match" ]; then
            echo "$match"
            return 0
        fi
    fi

    # Try by role (PLAN, WORK, REVIEW)
    local match=$(echo "$panes" | awk -F'|' -v role="$target" '$3 == role {print $1; exit}')
    if [ -n "$match" ]; then
        echo "$match"
        return 0
    fi

    # Try by title (partial match)
    match=$(echo "$panes" | awk -F'|' -v title="$target" '$4 ~ title {print $1; exit}')
    if [ -n "$match" ]; then
        echo "$match"
        return 0
    fi

    return 1
}

# Get role for a pane
get_pane_role() {
    local pane_id="$1"
    tmux display-message -t "$pane_id" -p '#{@role}' 2>/dev/null || echo ""
}

# Interactive pane selection
select_pane_interactive() {
    local prompt="$1"
    local exclude_id="${2:-}"

    local panes=$(get_panes)

    # Filter out excluded pane if specified
    if [ -n "$exclude_id" ]; then
        panes=$(echo "$panes" | grep -v "^$exclude_id|")
    fi

    if [ -z "$panes" ]; then
        echo -e "${RED}No panes available${NC}" >&2
        exit 1
    fi

    # Format for fzf: show role and title
    local formatted=$(echo "$panes" | awk -F'|' '{
        role = $3 ? $3 : "PANE"
        title = $4 ? $4 : "(no title)"
        printf "%s|%s: %s\n", $1, role, title
    }')

    local selected=$(echo "$formatted" | fzf \
        --height=50% \
        --layout=reverse \
        --border=rounded \
        --prompt="$prompt > " \
        --header="Select pane (? help, ESC cancel)" \
        --delimiter='|' \
        --with-nth=2 \
        --preview="tmux capture-pane -p -t {1} 2>/dev/null | tail -30" \
        --preview-window=right:50%:wrap \
        --bind='?:execute(~/.local/bin/agent-help)')

    [ -z "$selected" ] && exit 0

    echo "$selected" | cut -d'|' -f1
}

# Perform the handoff
do_handoff() {
    local source_id="$1"
    local target_id="$2"

    # Get roles for template
    local source_role=$(get_pane_role "$source_id")
    local target_role=$(get_pane_role "$target_id")

    # Capture source content (last 50 non-empty lines, strip ANSI)
    local content=$(tmux capture-pane -p -t "$source_id" 2>/dev/null | \
        sed 's/\x1b\[[0-9;]*m//g' | \
        grep -v '^[[:space:]]*$' | \
        tail -50)

    if [ -z "$content" ]; then
        echo -e "${YELLOW}Warning: Source pane appears empty${NC}"
    fi

    # Get template
    local template=$(get_handoff_template "$source_role" "$target_role")

    # Format handoff message
    local handoff=$(printf "%s\n\n---\n%s\n---\n" "$template" "$content")

    # Load into tmux buffer and paste to target
    echo "$handoff" | tmux load-buffer -
    tmux paste-buffer -t "$target_id"

    # Update workflow state based on target role
    if command -v agent-flow-state &>/dev/null; then
        case "$target_role" in
            WORK)   agent-flow-state set WORKING 2>/dev/null ;;
            REVIEW) agent-flow-state set REVIEWING 2>/dev/null ;;
            PLAN)   agent-flow-state set PLANNING 2>/dev/null ;;
        esac
    fi

    echo -e "${GREEN}Handoff: ${source_role:-source} -> ${target_role:-target}${NC}"
}

# Main
main() {
    # Check session exists
    if ! tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        echo -e "${RED}Error: Session '$SESSION_NAME' not found${NC}"
        exit 1
    fi

    case "${1:-}" in
        --help|-h)
            show_usage
            exit 0
            ;;
    esac

    if [ $# -ge 2 ]; then
        # Direct mode: agent-handoff <source> <target>
        local source_id=$(resolve_pane "$1")
        local target_id=$(resolve_pane "$2")

        if [ -z "$source_id" ]; then
            echo -e "${RED}Error: Source pane '$1' not found${NC}"
            exit 1
        fi
        if [ -z "$target_id" ]; then
            echo -e "${RED}Error: Target pane '$2' not found${NC}"
            exit 1
        fi

        do_handoff "$source_id" "$target_id"
    else
        # Interactive mode with clipboard support
        check_fzf

        # Check clipboard first
        local clipboard_content
        clipboard_content=$(get_clipboard_content)

        local handoff_content=""
        local source_desc=""
        local source_role=""

        if [[ -n "$clipboard_content" ]]; then
            # Clipboard has content - ask what to send
            local content_source
            content_source=$(select_content_source "$clipboard_content")

            case "$content_source" in
                CLIPBOARD)
                    handoff_content="$clipboard_content"
                    source_desc="clipboard selection"
                    source_role="selection"
                    ;;
                PANE)
                    local current_pane
                    current_pane=$(tmux display-message -p '#{pane_id}')
                    handoff_content=$(capture_pane_content "$current_pane")
                    source_role=$(tmux display-message -p '#{@role}')
                    source_desc="pane content"
                    ;;
                CANCEL|"")
                    echo -e "${DIM}Handoff cancelled${NC}"
                    exit 0
                    ;;
            esac
        else
            # No clipboard - use current pane
            local current_pane
            current_pane=$(tmux display-message -p '#{pane_id}')
            handoff_content=$(capture_pane_content "$current_pane")
            source_role=$(tmux display-message -p '#{@role}')
            source_desc="pane content"
        fi

        # Select target pane
        echo -e "${CYAN}Select target pane:${NC}"
        local target_id
        target_id=$(select_pane_interactive "Target")

        if [[ -z "$target_id" ]]; then
            echo -e "${RED}No target selected${NC}"
            exit 1
        fi

        # Get target role for template
        local target_role
        target_role=$(tmux display-message -p -t "$target_id" '#{@role}')

        # Create handoff message with template
        local template
        template=$(get_handoff_template "$source_role" "$target_role")
        local handoff
        handoff=$(printf "%s\n\n---\n%s\n---\n" "$template" "$handoff_content")

        # Send to target
        echo "$handoff" | tmux load-buffer -
        tmux paste-buffer -t "$target_id"

        # Update workflow state based on target role
        if command -v agent-flow-state &>/dev/null; then
            case "$target_role" in
                WORK)   agent-flow-state set WORKING 2>/dev/null ;;
                REVIEW) agent-flow-state set REVIEWING 2>/dev/null ;;
                PLAN)   agent-flow-state set PLANNING 2>/dev/null ;;
            esac
        fi

        echo -e "${GREEN}Sent ${source_desc} to ${target_role:-target pane}${NC}"
    fi
}

main "$@"
