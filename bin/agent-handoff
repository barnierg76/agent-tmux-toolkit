#!/bin/bash
# agent-handoff - Transfer context between panes with smart formatting
# Usage: agent-handoff (interactive) or agent-handoff <source> <target>
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
DIM='\033[2m'
NC='\033[0m'

# Get session name from environment or detect from tmux
get_session_name() {
    if [ -n "$AGENT_SESSION" ]; then
        echo "$AGENT_SESSION"
    elif tmux display-message -p '#{session_name}' 2>/dev/null; then
        :
    else
        echo "agents"
    fi
}

SESSION_NAME=$(get_session_name)

show_usage() {
    cat << 'EOF'
agent-handoff - Transfer context between panes

USAGE:
    agent-handoff              Interactive mode (pick source and target)
    agent-handoff <src> <dst>  Direct handoff between panes

ARGUMENTS:
    <src>   Source pane (index or name like PLAN, WORK, REVIEW)
    <dst>   Target pane (index or name like PLAN, WORK, REVIEW)

EXAMPLES:
    agent-handoff              # Interactive picker
    agent-handoff PLAN WORK    # Transfer from PLAN to WORK
    agent-handoff 0 1          # Transfer from pane 0 to pane 1

HANDOFF TEMPLATES:
    PLAN -> WORK    "Here's the plan to implement:"
    WORK -> REVIEW  "Please review this implementation:"
    REVIEW -> WORK  "Review feedback to address:"
    REVIEW -> PLAN  "Issues found that need re-planning:"
EOF
}

# Check if fzf is available
check_fzf() {
    if ! command -v fzf &> /dev/null; then
        echo -e "${RED}Error: fzf is required for interactive mode${NC}"
        echo "Install with: brew install fzf"
        exit 1
    fi
}

# Get list of panes with their info
get_panes() {
    tmux list-panes -t "$SESSION_NAME" -F "#{pane_id}|#{pane_index}|#{@role}|#{pane_title}" 2>/dev/null
}

# Get handoff template based on source -> target roles
get_handoff_template() {
    local from_role="$1"
    local to_role="$2"

    case "${from_role}_to_${to_role}" in
        PLAN*_to_WORK*)
            echo "Here's the plan to implement:"
            ;;
        WORK*_to_REVIEW*)
            echo "Please review this implementation:"
            ;;
        REVIEW*_to_WORK*)
            echo "Review feedback to address:"
            ;;
        REVIEW*_to_PLAN*)
            echo "Issues found that need re-planning:"
            ;;
        *)
            echo "Context from ${from_role:-pane}:"
            ;;
    esac
}

# Resolve pane name/index to pane ID
resolve_pane() {
    local target="$1"
    local panes=$(get_panes)

    # Try by index first
    if [[ "$target" =~ ^[0-9]+$ ]]; then
        local match=$(echo "$panes" | awk -F'|' -v idx="$target" '$2 == idx {print $1; exit}')
        if [ -n "$match" ]; then
            echo "$match"
            return 0
        fi
    fi

    # Try by role (PLAN, WORK, REVIEW)
    local match=$(echo "$panes" | awk -F'|' -v role="$target" '$3 == role {print $1; exit}')
    if [ -n "$match" ]; then
        echo "$match"
        return 0
    fi

    # Try by title (partial match)
    match=$(echo "$panes" | awk -F'|' -v title="$target" '$4 ~ title {print $1; exit}')
    if [ -n "$match" ]; then
        echo "$match"
        return 0
    fi

    return 1
}

# Get role for a pane
get_pane_role() {
    local pane_id="$1"
    tmux display-message -t "$pane_id" -p '#{@role}' 2>/dev/null || echo ""
}

# Interactive pane selection
select_pane_interactive() {
    local prompt="$1"
    local exclude_id="${2:-}"

    local panes=$(get_panes)

    # Filter out excluded pane if specified
    if [ -n "$exclude_id" ]; then
        panes=$(echo "$panes" | grep -v "^$exclude_id|")
    fi

    if [ -z "$panes" ]; then
        echo -e "${RED}No panes available${NC}" >&2
        exit 1
    fi

    # Format for fzf: show role and title
    local formatted=$(echo "$panes" | awk -F'|' '{
        role = $3 ? $3 : "PANE"
        title = $4 ? $4 : "(no title)"
        printf "%s|%s: %s\n", $1, role, title
    }')

    local selected=$(echo "$formatted" | fzf \
        --height=50% \
        --layout=reverse \
        --border=rounded \
        --prompt="$prompt â€º " \
        --delimiter='|' \
        --with-nth=2 \
        --preview="tmux capture-pane -p -t {1} 2>/dev/null | tail -30" \
        --preview-window=right:50%:wrap)

    [ -z "$selected" ] && exit 0

    echo "$selected" | cut -d'|' -f1
}

# Perform the handoff
do_handoff() {
    local source_id="$1"
    local target_id="$2"

    # Get roles for template
    local source_role=$(get_pane_role "$source_id")
    local target_role=$(get_pane_role "$target_id")

    # Capture source content (last 50 non-empty lines, strip ANSI)
    local content=$(tmux capture-pane -p -t "$source_id" 2>/dev/null | \
        sed 's/\x1b\[[0-9;]*m//g' | \
        grep -v '^[[:space:]]*$' | \
        tail -50)

    if [ -z "$content" ]; then
        echo -e "${YELLOW}Warning: Source pane appears empty${NC}"
    fi

    # Get template
    local template=$(get_handoff_template "$source_role" "$target_role")

    # Format handoff message
    local handoff=$(printf "%s\n\n---\n%s\n---\n" "$template" "$content")

    # Load into tmux buffer and paste to target
    echo "$handoff" | tmux load-buffer -
    tmux paste-buffer -t "$target_id"

    # Update workflow state based on target role
    if command -v agent-flow-state &>/dev/null; then
        case "$target_role" in
            WORK)   agent-flow-state set WORKING 2>/dev/null ;;
            REVIEW) agent-flow-state set REVIEWING 2>/dev/null ;;
            PLAN)   agent-flow-state set PLANNING 2>/dev/null ;;
        esac
    fi

    echo -e "${GREEN}Handoff: ${source_role:-source} -> ${target_role:-target}${NC}"
}

# Main
main() {
    # Check session exists
    if ! tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        echo -e "${RED}Error: Session '$SESSION_NAME' not found${NC}"
        exit 1
    fi

    case "${1:-}" in
        --help|-h)
            show_usage
            exit 0
            ;;
    esac

    if [ $# -ge 2 ]; then
        # Direct mode: agent-handoff <source> <target>
        local source_id=$(resolve_pane "$1")
        local target_id=$(resolve_pane "$2")

        if [ -z "$source_id" ]; then
            echo -e "${RED}Error: Source pane '$1' not found${NC}"
            exit 1
        fi
        if [ -z "$target_id" ]; then
            echo -e "${RED}Error: Target pane '$2' not found${NC}"
            exit 1
        fi

        do_handoff "$source_id" "$target_id"
    else
        # Interactive mode
        check_fzf

        echo -e "${BLUE}Select source pane:${NC}"
        local source_id=$(select_pane_interactive "Source")
        [ -z "$source_id" ] && exit 0

        echo -e "${BLUE}Select target pane:${NC}"
        local target_id=$(select_pane_interactive "Target" "$source_id")
        [ -z "$target_id" ] && exit 0

        do_handoff "$source_id" "$target_id"
    fi
}

main "$@"
