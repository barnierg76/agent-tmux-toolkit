#!/bin/bash
# agent-manage - Manage tmux agent panes and sessions
# Usage: agent-manage <command> [options]

set -e

SESSION_NAME="${AGENT_SESSION:-agents}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

show_help() {
    cat << 'EOF'
agent-manage - Manage tmux agent panes and sessions

USAGE:
    agent-manage <command> [options]

COMMANDS:
    open, o [name]      Open/attach to session (interactive picker if no name)
    new, n [name]       Create new agent session (default: agents)
    status, s           Show all panes and sessions
    add, a <n> [names]  Add n panes (optionally with names)
    close, c <n|name>   Close pane by index or name
    kill, k <target>    Kill session(s): 'all', session name, or pane index
    rename, r <n> <name> Rename pane by index
    focus, f <n|name>   Focus on pane by index or name
    layout, l           Rebalance pane layout (even-horizontal)
    list, ls            List all tmux sessions

EXAMPLES:
    agent-manage open                # Pick session interactively
    agent-manage open agents         # Attach to 'agents' session
    agent-manage new myproject       # Create new session 'myproject'
    agent-manage status              # Show current panes
    agent-manage add 2               # Add 2 new panes
    agent-manage add 2 DEBUG TEST    # Add 2 panes named DEBUG and TEST
    agent-manage close 3             # Close pane 3
    agent-manage kill agents         # Kill 'agents' session
    agent-manage kill all            # Kill ALL tmux sessions

ENVIRONMENT:
    AGENT_SESSION    Session name (default: agents)
EOF
}

# Check if in tmux or session exists
check_session() {
    if ! tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        echo -e "${RED}Error: Session '$SESSION_NAME' not found.${NC}"
        echo "Start with: agent-session"
        exit 1
    fi
}

# Show status of all panes
cmd_status() {
    echo -e "${BLUE}=== TMUX Agent Status ===${NC}"
    echo ""

    # List sessions
    echo -e "${YELLOW}Sessions:${NC}"
    tmux list-sessions 2>/dev/null | while read -r line; do
        if [[ "$line" == *"$SESSION_NAME"* ]]; then
            echo -e "  ${GREEN}â†’ $line${NC}"
        else
            echo "    $line"
        fi
    done
    echo ""

    # List panes in current session
    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        echo -e "${YELLOW}Panes in '$SESSION_NAME':${NC}"
        tmux list-panes -t "$SESSION_NAME" -F "  #{pane_index}: #{pane_title} (#{pane_width}x#{pane_height}) #{?pane_active,${GREEN}[ACTIVE]${NC},}"
        echo ""
        PANE_COUNT=$(tmux list-panes -t "$SESSION_NAME" | wc -l | tr -d ' ')
        echo -e "${YELLOW}Total panes: ${GREEN}$PANE_COUNT${NC}"
    else
        echo -e "${RED}Session '$SESSION_NAME' not found${NC}"
    fi
}

# Add n panes with optional names
cmd_add() {
    check_session

    local count="${1:-1}"
    shift 2>/dev/null || true
    local names=("$@")

    if ! [[ "$count" =~ ^[0-9]+$ ]]; then
        echo -e "${RED}Error: Count must be a number${NC}"
        exit 1
    fi

    echo -e "${BLUE}Adding $count pane(s) to '$SESSION_NAME'...${NC}"

    for ((i=0; i<count; i++)); do
        # Add new pane
        tmux split-window -h -t "$SESSION_NAME" -c "$(pwd)"

        # Get the new pane index
        local new_pane=$(tmux list-panes -t "$SESSION_NAME" -F "#{pane_index}" | tail -1)

        # Set name if provided
        if [[ -n "${names[$i]}" ]]; then
            tmux select-pane -t "$SESSION_NAME.$new_pane" -T "${names[$i]}"
            echo -e "  ${GREEN}Added pane $new_pane: ${names[$i]}${NC}"
        else
            tmux select-pane -t "$SESSION_NAME.$new_pane" -T "AGENT-$new_pane"
            echo -e "  ${GREEN}Added pane $new_pane: AGENT-$new_pane${NC}"
        fi
    done

    # Rebalance layout
    tmux select-layout -t "$SESSION_NAME" even-horizontal
    echo -e "${GREEN}Layout rebalanced.${NC}"
}

# Close pane by index or name
cmd_close() {
    check_session

    local target="$1"

    if [[ -z "$target" ]]; then
        echo -e "${RED}Error: Specify pane index or name${NC}"
        exit 1
    fi

    # Check if target is a number (index) or name
    if [[ "$target" =~ ^[0-9]+$ ]]; then
        tmux kill-pane -t "$SESSION_NAME.$target" 2>/dev/null && \
            echo -e "${GREEN}Closed pane $target${NC}" || \
            echo -e "${RED}Error: Pane $target not found${NC}"
    else
        # Find pane by name
        local pane_index=$(tmux list-panes -t "$SESSION_NAME" -F "#{pane_index}:#{pane_title}" | grep ":$target" | cut -d: -f1 | head -1)
        if [[ -n "$pane_index" ]]; then
            tmux kill-pane -t "$SESSION_NAME.$pane_index"
            echo -e "${GREEN}Closed pane '$target' (index $pane_index)${NC}"
        else
            echo -e "${RED}Error: Pane named '$target' not found${NC}"
            exit 1
        fi
    fi

    # Rebalance if panes remain
    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        tmux select-layout -t "$SESSION_NAME" even-horizontal 2>/dev/null
    fi
}

# Kill session(s)
cmd_kill() {
    local target="$1"

    if [[ -z "$target" ]]; then
        echo -e "${RED}Error: Specify 'all', session name, or pane index${NC}"
        exit 1
    fi

    case "$target" in
        all)
            echo -e "${YELLOW}Killing ALL tmux sessions...${NC}"
            tmux kill-server 2>/dev/null && \
                echo -e "${GREEN}All sessions killed.${NC}" || \
                echo -e "${YELLOW}No tmux server running.${NC}"
            ;;
        *)
            # Check if it's a pane index in current session
            if [[ "$target" =~ ^[0-9]+$ ]] && tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
                tmux kill-pane -t "$SESSION_NAME.$target" 2>/dev/null && \
                    echo -e "${GREEN}Killed pane $target in '$SESSION_NAME'${NC}" || \
                    echo -e "${RED}Pane $target not found${NC}"
            else
                # Treat as session name
                tmux kill-session -t "$target" 2>/dev/null && \
                    echo -e "${GREEN}Killed session '$target'${NC}" || \
                    echo -e "${RED}Session '$target' not found${NC}"
            fi
            ;;
    esac
}

# Rename pane
cmd_rename() {
    check_session

    local index="$1"
    local name="$2"

    if [[ -z "$index" ]] || [[ -z "$name" ]]; then
        echo -e "${RED}Error: Usage: agent-manage rename <index> <name>${NC}"
        exit 1
    fi

    tmux select-pane -t "$SESSION_NAME.$index" -T "$name" 2>/dev/null && \
        echo -e "${GREEN}Renamed pane $index to '$name'${NC}" || \
        echo -e "${RED}Error: Pane $index not found${NC}"
}

# Focus on pane
cmd_focus() {
    check_session

    local target="$1"

    if [[ -z "$target" ]]; then
        echo -e "${RED}Error: Specify pane index or name${NC}"
        exit 1
    fi

    if [[ "$target" =~ ^[0-9]+$ ]]; then
        tmux select-pane -t "$SESSION_NAME.$target" 2>/dev/null && \
            echo -e "${GREEN}Focused on pane $target${NC}" || \
            echo -e "${RED}Error: Pane $target not found${NC}"
    else
        local pane_index=$(tmux list-panes -t "$SESSION_NAME" -F "#{pane_index}:#{pane_title}" | grep ":$target" | cut -d: -f1 | head -1)
        if [[ -n "$pane_index" ]]; then
            tmux select-pane -t "$SESSION_NAME.$pane_index"
            echo -e "${GREEN}Focused on pane '$target' (index $pane_index)${NC}"
        else
            echo -e "${RED}Error: Pane named '$target' not found${NC}"
        fi
    fi
}

# Rebalance layout
cmd_layout() {
    check_session
    tmux select-layout -t "$SESSION_NAME" even-horizontal
    echo -e "${GREEN}Layout rebalanced.${NC}"
}

# List all sessions
cmd_list() {
    echo -e "${BLUE}=== All TMUX Sessions ===${NC}"
    tmux list-sessions 2>/dev/null || echo -e "${YELLOW}No tmux sessions running.${NC}"
}

# Interactive main menu
cmd_menu() {
    if ! command -v fzf &> /dev/null; then
        echo -e "${RED}fzf required for interactive menu. Install with: brew install fzf${NC}"
        show_help
        exit 1
    fi

    while true; do
        # Build menu options
        local menu=""

        # Sessions section
        menu+="â”â”â” SESSIONS â”â”â”"$'\n'
        menu+="âž• New session"$'\n'

        if tmux list-sessions &>/dev/null; then
            while IFS='|' read -r name windows status; do
                if [[ "$status" == "attached" ]]; then
                    menu+="ðŸŸ¢ $name ($windows, $status)"$'\n'
                else
                    menu+="âšª $name ($windows, $status)"$'\n'
                fi
            done < <(tmux list-sessions -F "#{session_name}|#{session_windows} windows|#{?session_attached,attached,detached}" 2>/dev/null)
        fi

        # Actions section
        menu+="â”â”â” ACTIONS â”â”â”"$'\n'
        menu+="ðŸ“Š Status - show panes & sessions"$'\n'
        menu+="âž• Add panes"$'\n'
        menu+="ðŸ“ Layout - rebalance panes"$'\n'
        menu+="ðŸ·ï¸  Rename pane"$'\n'
        menu+="ðŸŽ¯ Focus pane"$'\n'
        menu+="âŒ Close pane"$'\n'
        menu+="ðŸ’€ Kill session"$'\n'

        local selected
        selected=$(echo -e "$menu" | fzf \
            --height=80% \
            --layout=reverse \
            --border=rounded \
            --prompt="â€º " \
            --header="agent-manage (â† back, ESC quit)" \
            --no-preview \
            --bind='left:abort' \
            --expect='left')

        # Check for left arrow (go back - but we're at top level, so just refresh)
        local first_line=$(echo "$selected" | head -1)
        [[ "$first_line" == "left" ]] && continue

        selected=$(echo "$selected" | tail -n +2)
        [[ -z "$selected" ]] && exit 0

        # Skip separator lines
        [[ "$selected" == â”â”â”* ]] && continue

        # Handle selection
        case "$selected" in
            "âž• New session")
                read -p "Session name [agents]: " session_name
                session_name="${session_name:-agents}"
                cmd_new "$session_name"
                exit 0
                ;;
            "ðŸ“Š Status"*)
                cmd_status
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "âž• Add panes")
                read -p "How many panes to add? [1]: " count
                count="${count:-1}"
                read -p "Names (space-separated, optional): " -a names
                cmd_add "$count" "${names[@]}"
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "ðŸ“ Layout"*)
                cmd_layout
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "ðŸ·ï¸"*"Rename"*)
                read -p "Pane index to rename: " index
                read -p "New name: " name
                if [[ -n "$index" && -n "$name" ]]; then
                    cmd_rename "$index" "$name"
                fi
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "ðŸŽ¯ Focus"*)
                read -p "Pane index or name to focus: " target
                if [[ -n "$target" ]]; then
                    cmd_focus "$target"
                fi
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "âŒ Close"*)
                read -p "Pane index or name to close: " target
                if [[ -n "$target" ]]; then
                    cmd_close "$target"
                fi
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "ðŸ’€ Kill"*)
                echo "Options: session name, pane index, or 'all'"
                read -p "What to kill: " target
                if [[ -n "$target" ]]; then
                    cmd_kill "$target"
                fi
                echo ""
                read -p "Press Enter to continue..."
                ;;
            ðŸŸ¢*|âšª*)
                # Session selected - attach to it
                local session_name
                session_name=$(echo "$selected" | sed 's/^[ðŸŸ¢âšª] //; s/ (.*//')
                tmux attach -t "$session_name"
                exit 0
                ;;
        esac
    done
}

# Open/attach to session (interactive if no name given)
cmd_open() {
    local target="$1"

    # If target specified, attach directly
    if [[ -n "$target" ]]; then
        if tmux has-session -t "$target" 2>/dev/null; then
            tmux attach -t "$target"
        else
            echo -e "${RED}Session '$target' not found.${NC}"
            echo "Available sessions:"
            tmux list-sessions 2>/dev/null || echo "  (none)"
            exit 1
        fi
        return
    fi

    # No target - show interactive menu
    cmd_menu
}

# Create new agent session
cmd_new() {
    local session_name="${1:-agents}"

    if tmux has-session -t "$session_name" 2>/dev/null; then
        echo -e "${YELLOW}Session '$session_name' already exists. Attaching...${NC}"
        tmux attach -t "$session_name"
        return
    fi

    # Use agent-session script if available
    if command -v agent-session &> /dev/null; then
        agent-session "$session_name"
    else
        # Fallback: create basic 3-pane layout
        tmux new-session -d -s "$session_name" -n "agents"
        tmux split-window -h -t "$session_name:agents"
        tmux split-window -h -t "$session_name:agents"
        tmux select-layout -t "$session_name:agents" even-horizontal

        # Name panes
        local panes=($(tmux list-panes -t "$session_name:agents" -F "#{pane_index}"))
        tmux select-pane -t "$session_name:agents.${panes[0]}" -T "PLAN"
        tmux select-pane -t "$session_name:agents.${panes[1]}" -T "WORK"
        tmux select-pane -t "$session_name:agents.${panes[2]}" -T "REVIEW"

        tmux attach -t "$session_name"
    fi
}

# Main command router
case "${1:-}" in
    open|o)
        shift
        cmd_open "$@"
        ;;
    new|n)
        shift
        cmd_new "$@"
        ;;
    status|s)
        cmd_status
        ;;
    add|a)
        shift
        cmd_add "$@"
        ;;
    close|c)
        shift
        cmd_close "$@"
        ;;
    kill|k)
        shift
        cmd_kill "$@"
        ;;
    rename|r)
        shift
        cmd_rename "$@"
        ;;
    focus|f)
        shift
        cmd_focus "$@"
        ;;
    layout|l)
        cmd_layout
        ;;
    list|ls)
        cmd_list
        ;;
    help|--help|-h)
        show_help
        ;;
    "")
        # No command - default to open (interactive session picker)
        cmd_open
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'agent-manage help' for usage"
        exit 1
        ;;
esac
