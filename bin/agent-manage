#!/bin/bash
# agent-manage - Manage tmux agent panes and sessions
# Usage: agent-manage <command> [options]

set -e

SESSION_NAME="${AGENT_SESSION:-agents}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color


# Validate name - alphanumeric, dash, underscore only
validate_name() {
    local name="$1"
    local type="${2:-name}"
    if ! [[ "$name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        echo -e "${RED}Error: Invalid $type. Use only alphanumeric, dash, underscore.${NC}" >&2
        return 1
    fi
    return 0
}

# Cross-platform clipboard copy
copy_to_clipboard() {
    local content="$1"

    if command -v pbcopy &>/dev/null; then
        echo -n "$content" | pbcopy
    elif command -v xclip &>/dev/null; then
        echo -n "$content" | xclip -selection clipboard
    elif command -v xsel &>/dev/null; then
        echo -n "$content" | xsel --clipboard --input
    elif command -v wl-copy &>/dev/null; then
        echo -n "$content" | wl-copy
    elif command -v clip.exe &>/dev/null; then
        echo -n "$content" | clip.exe
    else
        echo -e "${RED}No clipboard tool found${NC}"
        echo "Install one of: pbcopy (macOS), xclip, xsel (Linux), wl-copy (Wayland)"
        return 1
    fi
}

# Cross-platform clipboard paste
paste_from_clipboard() {
    if command -v pbpaste &>/dev/null; then
        pbpaste
    elif command -v xclip &>/dev/null; then
        xclip -selection clipboard -o
    elif command -v xsel &>/dev/null; then
        xsel --clipboard --output
    elif command -v wl-paste &>/dev/null; then
        wl-paste
    elif command -v powershell.exe &>/dev/null; then
        powershell.exe -command "Get-Clipboard" | tr -d '\r'
    else
        echo -e "${RED}No clipboard tool found${NC}" >&2
        echo "Install one of: pbpaste (macOS), xclip, xsel (Linux), wl-paste (Wayland)" >&2
        return 1
    fi
}

show_help() {
    cat << 'EOF'
agent-manage - Manage tmux agent panes and sessions

USAGE:
    agent-manage <command> [options]

COMMANDS:
    open, o [name]      Open/attach to session (interactive picker if no name)
    new, n [name]       Create new agent session (default: agents)
    status, s           Show all panes and sessions
    add, a <n> [names]  Add n panes (optionally with names)
    close, c <n|name>   Close pane by index or name
    kill, k <target>    Kill session(s): 'all', session name, or pane index
    rename, r <n> <name> Rename pane by index
    focus, f <n|name>   Focus on pane by index or name
    copy, cp [n|name]   Copy pane content to clipboard (interactive if no target)
    copy-full, cpf [n|name] Copy full scrollback history to clipboard
    paste, p [n|name]   Paste clipboard content to pane (interactive if no target)
    layout, l           Rebalance pane layout (even-horizontal)
    list, ls            List all tmux sessions

EXAMPLES:
    agent-manage open                # Pick session interactively
    agent-manage open agents         # Attach to 'agents' session
    agent-manage new myproject       # Create new session 'myproject'
    agent-manage status              # Show current panes
    agent-manage add 2               # Add 2 new panes
    agent-manage add 2 DEBUG TEST    # Add 2 panes named DEBUG and TEST
    agent-manage close 3             # Close pane 3
    agent-manage copy 0              # Copy pane 0 content to clipboard
    agent-manage copy-full WORK      # Copy full history of WORK pane
    agent-manage paste 1             # Paste clipboard to pane 1
    agent-manage kill agents         # Kill 'agents' session
    agent-manage kill all            # Kill ALL tmux sessions

ENVIRONMENT:
    AGENT_SESSION    Session name (default: agents)
EOF
}

# Check if in tmux or session exists
check_session() {
    if ! tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        echo -e "${RED}Error: Session '$SESSION_NAME' not found.${NC}"
        echo "Start with: agent-session"
        exit 1
    fi
}

# Resolve pane target (name or index) to pane index
# Returns: pane index on stdout, exit 1 if not found
resolve_pane() {
    local target="$1"

    # If numeric, verify it exists
    if [[ "$target" =~ ^[0-9]+$ ]]; then
        if tmux list-panes -t "$SESSION_NAME" -F "#{pane_index}" 2>/dev/null | grep -q "^$target$"; then
            echo "$target"
            return 0
        fi
    else
        # Find by name
        local index
        index=$(tmux list-panes -t "$SESSION_NAME" -F "#{pane_index}:#{pane_title}" 2>/dev/null | \
            awk -F: -v name="$target" '$2 == name {print $1; exit}')
        if [[ -n "$index" ]]; then
            echo "$index"
            return 0
        fi
    fi
    return 1
}

# Show status of all panes
cmd_status() {
    echo -e "${BLUE}=== TMUX Agent Status ===${NC}"
    echo ""

    # List sessions
    echo -e "${YELLOW}Sessions:${NC}"
    tmux list-sessions 2>/dev/null | while read -r line; do
        if [[ "$line" == *"$SESSION_NAME"* ]]; then
            echo -e "  ${GREEN}â†’ $line${NC}"
        else
            echo "    $line"
        fi
    done
    echo ""

    # List panes in current session
    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        echo -e "${YELLOW}Panes in '$SESSION_NAME':${NC}"
        tmux list-panes -t "$SESSION_NAME" -F "  #{pane_index}: #{pane_title} (#{pane_width}x#{pane_height}) #{?pane_active,${GREEN}[ACTIVE]${NC},}"
        echo ""
        PANE_COUNT=$(tmux list-panes -t "$SESSION_NAME" | wc -l | tr -d ' ')
        echo -e "${YELLOW}Total panes: ${GREEN}$PANE_COUNT${NC}"
    else
        echo -e "${RED}Session '$SESSION_NAME' not found${NC}"
    fi
}

# Add n panes with optional names
cmd_add() {
    check_session

    local count="${1:-1}"
    shift 2>/dev/null || true
    local names=("$@")

    if ! [[ "$count" =~ ^[0-9]+$ ]]; then
        echo -e "${RED}Error: Count must be a number${NC}"
        exit 1
    fi

    echo -e "${BLUE}Adding $count pane(s) to '$SESSION_NAME'...${NC}"

    for ((i=0; i<count; i++)); do
        # Add new pane
        tmux split-window -h -t "$SESSION_NAME" -c "$(pwd)"

        # Get the new pane index
        local new_pane=$(tmux list-panes -t "$SESSION_NAME" -F "#{pane_index}" | tail -1)

        # Set name if provided
        if [[ -n "${names[$i]}" ]]; then
            if validate_name "${names[$i]}" "pane name"; then
                tmux select-pane -t "$SESSION_NAME.$new_pane" -T "${names[$i]}"
                echo -e "  ${GREEN}Added pane $new_pane: ${names[$i]}${NC}"
            else
                # Use default name if validation fails
                tmux select-pane -t "$SESSION_NAME.$new_pane" -T "AGENT-$new_pane"
                echo -e "  ${YELLOW}Used default name for pane $new_pane: AGENT-$new_pane${NC}"
            fi
        else
            tmux select-pane -t "$SESSION_NAME.$new_pane" -T "AGENT-$new_pane"
            echo -e "  ${GREEN}Added pane $new_pane: AGENT-$new_pane${NC}"
        fi
    done

    # Rebalance layout
    tmux select-layout -t "$SESSION_NAME" even-horizontal
    echo -e "${GREEN}Layout rebalanced.${NC}"
}

# Close pane by index or name
cmd_close() {
    check_session
    local target="$1"

    [[ -z "$target" ]] && { echo -e "${RED}Error: Specify pane index or name${NC}"; exit 1; }

    local pane
    if ! pane=$(resolve_pane "$target"); then
        echo -e "${RED}Error: Pane '$target' not found${NC}"
        exit 1
    fi

    tmux kill-pane -t "$SESSION_NAME.$pane"
    echo -e "${GREEN}Closed pane $pane${NC}"

    # Rebalance if panes remain
    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        tmux select-layout -t "$SESSION_NAME" even-horizontal 2>/dev/null
    fi
}

# Kill session(s)
cmd_kill() {
    local target="$1"

    if [[ -z "$target" ]]; then
        echo -e "${RED}Error: Specify 'all', session name, or pane index${NC}"
        exit 1
    fi

    case "$target" in
        all)
            echo -e "${YELLOW}Killing ALL tmux sessions...${NC}"
            tmux kill-server 2>/dev/null && \
                echo -e "${GREEN}All sessions killed.${NC}" || \
                echo -e "${YELLOW}No tmux server running.${NC}"
            ;;
        *)
            # Check if it's a pane index in current session
            if [[ "$target" =~ ^[0-9]+$ ]] && tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
                tmux kill-pane -t "$SESSION_NAME.$target" 2>/dev/null && \
                    echo -e "${GREEN}Killed pane $target in '$SESSION_NAME'${NC}" || \
                    echo -e "${RED}Pane $target not found${NC}"
            else
                # Treat as session name
                tmux kill-session -t "$target" 2>/dev/null && \
                    echo -e "${GREEN}Killed session '$target'${NC}" || \
                    echo -e "${RED}Session '$target' not found${NC}"
            fi
            ;;
    esac
}

# Rename pane
cmd_rename() {
    check_session

    local index="$1"
    local name="$2"

    if [[ -z "$index" ]] || [[ -z "$name" ]]; then
        echo -e "${RED}Error: Usage: agent-manage rename <index> <name>${NC}"
        exit 1
    fi

    tmux select-pane -t "$SESSION_NAME.$index" -T "$name" 2>/dev/null && \
        echo -e "${GREEN}Renamed pane $index to '$name'${NC}" || \
        echo -e "${RED}Error: Pane $index not found${NC}"
}

# Focus on pane
cmd_focus() {
    check_session
    local target="$1"

    [[ -z "$target" ]] && { echo -e "${RED}Error: Specify pane index or name${NC}"; exit 1; }

    local pane
    if ! pane=$(resolve_pane "$target"); then
        echo -e "${RED}Error: Pane '$target' not found${NC}"
        exit 1
    fi

    tmux select-pane -t "$SESSION_NAME.$pane"
    echo -e "${GREEN}Focused on pane $pane${NC}"
}

# Rebalance layout
cmd_layout() {
    check_session
    tmux select-layout -t "$SESSION_NAME" even-horizontal
    echo -e "${GREEN}Layout rebalanced.${NC}"
}

# List all sessions
cmd_list() {
    echo -e "${BLUE}=== All TMUX Sessions ===${NC}"
    tmux list-sessions 2>/dev/null || echo -e "${YELLOW}No tmux sessions running.${NC}"
}

# Create git worktree + agent session
cmd_worktree() {
    echo -e "${BLUE}Create Git Worktree + Agent Session${NC}"
    echo ""

    # Check if in git repo
    if ! git rev-parse --git-dir &>/dev/null; then
        echo -e "${RED}Error: Not a git repository${NC}"
        return 1
    fi

    read -p "Branch name: " branch
    [ -z "$branch" ] && return 0

    read -p "Base branch [main]: " base
    base="${base:-main}"

    # Call agent-worktree
    if command -v agent-worktree &>/dev/null; then
        agent-worktree "$branch" "$base"
    else
        echo -e "${RED}agent-worktree not found in PATH${NC}"
        return 1
    fi
}

# Delegate tasks to multiple agent sessions
cmd_delegate() {
    echo -e "${BLUE}Delegate Tasks to Parallel Agents${NC}"
    echo ""
    echo "Enter task names (space-separated):"
    read -p "> " tasks

    [ -z "$tasks" ] && return 0

    echo ""
    read -p "Also create git worktrees? [y/N]: " use_worktree

    if command -v agent-delegate &>/dev/null; then
        if [[ "$use_worktree" =~ ^[Yy]$ ]]; then
            agent-delegate --worktree $tasks
        else
            agent-delegate $tasks
        fi
    else
        echo -e "${RED}agent-delegate not found in PATH${NC}"
        return 1
    fi
}

# Show status of all agent sessions
cmd_status_all() {
    if command -v agent-status &>/dev/null; then
        agent-status
    else
        # Fallback inline implementation
        echo -e "${BLUE}=== Agent Sessions Status ===${NC}"
        echo ""

        local sessions
        sessions=$(tmux list-sessions -F "#{session_name}|#{session_windows}|#{session_attached}" 2>/dev/null | grep "^agent" || true)

        if [ -z "$sessions" ]; then
            echo -e "${YELLOW}No agent sessions found${NC}"
            return 0
        fi

        printf "%-25s %-10s %-12s\n" "SESSION" "WINDOWS" "STATUS"
        printf "%-25s %-10s %-12s\n" "-------" "-------" "------"

        while IFS='|' read -r name windows attached; do
            if [ "$attached" = "1" ]; then
                status="${GREEN}Active${NC}"
            else
                status="${YELLOW}Detached${NC}"
            fi
            printf "%-25s %-10s %-12b\n" "$name" "$windows" "$status"
        done <<< "$sessions"
    fi
}

# Copy pane content to clipboard (visible content only)
cmd_copy() {
    check_session

    local target="$1"
    local pane_idx

    # If target provided, use it directly
    if [[ -n "$target" ]]; then
        if [[ "$target" =~ ^[0-9]+$ ]]; then
            pane_idx="$target"
        else
            # Find pane by name
            pane_idx=$(tmux list-panes -t "$SESSION_NAME" -F "#{pane_index}:#{pane_title}" | grep ":$target" | cut -d: -f1 | head -1)
            if [[ -z "$pane_idx" ]]; then
                echo -e "${RED}Pane '$target' not found${NC}"
                return 1
            fi
        fi
    else
        # Interactive selection with fzf
        if ! command -v fzf &>/dev/null; then
            echo -e "${RED}fzf required for interactive selection${NC}"
            return 1
        fi

        local panes
        panes=$(tmux list-panes -t "$SESSION_NAME" \
            -F "#{pane_index}|#{pane_title}|#{pane_current_command}" 2>/dev/null)

        if [ -z "$panes" ]; then
            echo -e "${RED}No panes found in session${NC}"
            return 1
        fi

        # Format for display
        local display=""
        while IFS='|' read -r idx title cmd; do
            display+="$idx: $title ($cmd)"$'\n'
        done <<< "$panes"

        local selected
        selected=$(echo -e "$display" | sed '/^$/d' | fzf \
            --height=50% \
            --layout=reverse \
            --border=rounded \
            --prompt="Select pane to copy â€º " \
            --header="Copy pane content to clipboard" \
            --preview="tmux capture-pane -p -S -20 -t '$SESSION_NAME.{1}' 2>/dev/null | head -20" \
            --preview-window=right:50%:wrap)

        [ -z "$selected" ] && return 0

        pane_idx=$(echo "$selected" | cut -d: -f1 | tr -d ' ')
    fi

    # Capture pane content (visible only, strip ANSI codes)
    local content
    content=$(tmux capture-pane -p -t "$SESSION_NAME.$pane_idx" 2>/dev/null | \
        sed 's/\x1b\[[0-9;]*m//g')

    if [ -z "$content" ] || [ "$(echo "$content" | tr -d '[:space:]')" = "" ]; then
        echo -e "${YELLOW}Pane is empty (nothing to copy)${NC}"
        return 0
    fi

    if ! copy_to_clipboard "$content"; then
        return 1
    fi

    local line_count
    line_count=$(echo "$content" | wc -l | tr -d ' ')

    echo -e "${GREEN}Copied $line_count lines to clipboard${NC}"
}

# Copy pane content to clipboard (full scrollback history)
cmd_copy_full() {
    check_session

    local target="$1"
    local pane_idx

    # If target provided, use it directly
    if [[ -n "$target" ]]; then
        if [[ "$target" =~ ^[0-9]+$ ]]; then
            pane_idx="$target"
        else
            pane_idx=$(tmux list-panes -t "$SESSION_NAME" -F "#{pane_index}:#{pane_title}" | grep ":$target" | cut -d: -f1 | head -1)
            if [[ -z "$pane_idx" ]]; then
                echo -e "${RED}Pane '$target' not found${NC}"
                return 1
            fi
        fi
    else
        # Interactive selection with fzf
        if ! command -v fzf &>/dev/null; then
            echo -e "${RED}fzf required for interactive selection${NC}"
            return 1
        fi

        local panes
        panes=$(tmux list-panes -t "$SESSION_NAME" \
            -F "#{pane_index}|#{pane_title}|#{pane_current_command}" 2>/dev/null)

        if [ -z "$panes" ]; then
            echo -e "${RED}No panes found in session${NC}"
            return 1
        fi

        local display=""
        while IFS='|' read -r idx title cmd; do
            display+="$idx: $title ($cmd)"$'\n'
        done <<< "$panes"

        local selected
        selected=$(echo -e "$display" | sed '/^$/d' | fzf \
            --height=50% \
            --layout=reverse \
            --border=rounded \
            --prompt="Select pane to copy (full history) â€º " \
            --header="Copy FULL scrollback to clipboard" \
            --preview="tmux capture-pane -p -S - -t '$SESSION_NAME.{1}' 2>/dev/null | tail -30" \
            --preview-window=right:50%:wrap)

        [ -z "$selected" ] && return 0

        pane_idx=$(echo "$selected" | cut -d: -f1 | tr -d ' ')
    fi

    # Capture full scrollback (-S - means from start of history)
    local content
    content=$(tmux capture-pane -p -S - -t "$SESSION_NAME.$pane_idx" 2>/dev/null | \
        sed 's/\x1b\[[0-9;]*m//g')

    if [ -z "$content" ] || [ "$(echo "$content" | tr -d '[:space:]')" = "" ]; then
        echo -e "${YELLOW}Pane is empty (nothing to copy)${NC}"
        return 0
    fi

    if ! copy_to_clipboard "$content"; then
        return 1
    fi

    local line_count
    line_count=$(echo "$content" | wc -l | tr -d ' ')

    echo -e "${GREEN}Copied $line_count lines (full history) to clipboard${NC}"
}

# Paste clipboard content to pane
cmd_paste() {
    check_session

    local target="$1"
    local pane_idx

    # Get clipboard content first
    local content
    content=$(paste_from_clipboard 2>/dev/null)

    if [ -z "$content" ]; then
        echo -e "${YELLOW}Clipboard is empty (nothing to paste)${NC}"
        return 0
    fi

    # If target provided, use it directly
    if [[ -n "$target" ]]; then
        if [[ "$target" =~ ^[0-9]+$ ]]; then
            pane_idx="$target"
        else
            pane_idx=$(tmux list-panes -t "$SESSION_NAME" -F "#{pane_index}:#{pane_title}" | grep ":$target" | cut -d: -f1 | head -1)
            if [[ -z "$pane_idx" ]]; then
                echo -e "${RED}Pane '$target' not found${NC}"
                return 1
            fi
        fi
    else
        # Interactive selection with fzf
        if ! command -v fzf &>/dev/null; then
            echo -e "${RED}fzf required for interactive selection${NC}"
            return 1
        fi

        local panes
        panes=$(tmux list-panes -t "$SESSION_NAME" \
            -F "#{pane_index}|#{pane_title}|#{pane_current_command}" 2>/dev/null)

        if [ -z "$panes" ]; then
            echo -e "${RED}No panes found in session${NC}"
            return 1
        fi

        local display=""
        while IFS='|' read -r idx title cmd; do
            display+="$idx: $title ($cmd)"$'\n'
        done <<< "$panes"

        # Show preview of clipboard content
        local preview_content
        preview_content=$(echo "$content" | head -20)

        local selected
        selected=$(echo -e "$display" | sed '/^$/d' | fzf \
            --height=50% \
            --layout=reverse \
            --border=rounded \
            --prompt="Select pane to paste into â€º " \
            --header="Paste clipboard to pane" \
            --preview="echo 'Clipboard content:'; echo 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€'; echo '$preview_content'" \
            --preview-window=right:50%:wrap)

        [ -z "$selected" ] && return 0

        pane_idx=$(echo "$selected" | cut -d: -f1 | tr -d ' ')
    fi

    local line_count
    line_count=$(echo "$content" | wc -l | tr -d ' ')

    # Confirm before pasting multi-line content
    if [ "$line_count" -gt 1 ]; then
        echo -e "${YELLOW}About to paste $line_count lines to pane $pane_idx${NC}"
        echo -e "${YELLOW}First line: $(echo "$content" | head -1 | cut -c1-60)...${NC}"
        read -p "Continue? [y/N]: " confirm
        if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
            echo -e "${YELLOW}Cancelled${NC}"
            return 0
        fi
    fi

    # Send content to pane using tmux send-keys
    # Use -l to send literal string (doesn't interpret special keys)
    tmux send-keys -t "$SESSION_NAME.$pane_idx" -l "$content"

    echo -e "${GREEN}Pasted $line_count lines to pane $pane_idx${NC}"
}

# Interactive main menu
cmd_menu() {
    if ! command -v fzf &> /dev/null; then
        echo -e "${RED}fzf required for interactive menu. Install with: brew install fzf${NC}"
        show_help
        exit 1
    fi

    while true; do
        # Build menu options
        local menu=""

        # Sessions section
        menu+="â”â”â” SESSIONS â”â”â”"$'\n'
        menu+="âž• New session"$'\n'

        if tmux list-sessions &>/dev/null; then
            while IFS='|' read -r name windows status; do
                if [[ "$status" == "attached" ]]; then
                    menu+="ðŸŸ¢ $name ($windows, $status)"$'\n'
                else
                    menu+="âšª $name ($windows, $status)"$'\n'
                fi
            done < <(tmux list-sessions -F "#{session_name}|#{session_windows} windows|#{?session_attached,attached,detached}" 2>/dev/null)
        fi

        # Actions section
        menu+="â”â”â” ACTIONS â”â”â”"$'\n'
        menu+="ðŸ“Š Status - show panes & sessions"$'\n'
        menu+="âž• Add panes"$'\n'
        menu+="ðŸ“ Layout - rebalance panes"$'\n'
        menu+="ðŸ·ï¸  Rename pane"$'\n'
        menu+="ðŸŽ¯ Focus pane"$'\n'
        menu+="ðŸ“‹ Copy pane"$'\n'
        menu+="ðŸ“œ Copy pane (full history)"$'\n'
        menu+="ðŸ“¥ Paste to pane"$'\n'
        menu+="â”â”â” PARALLEL WORK â”â”â”"$'\n'
        menu+="ðŸŒ³ Create worktree"$'\n'
        menu+="ðŸš€ Delegate tasks"$'\n'
        menu+="ðŸ“Š All sessions status"$'\n'
        menu+="â”â”â” CLEANUP â”â”â”"$'\n'
        menu+="âŒ Close pane"$'\n'
        menu+="ðŸ’€ Kill session"$'\n'

        local selected
        selected=$(echo -e "$menu" | fzf \
            --height=80% \
            --layout=reverse \
            --border=rounded \
            --prompt="â€º " \
            --header="agent-manage (â† back, ESC quit)" \
            --no-preview \
            --bind='left:abort' \
            --expect='left')

        # Check for left arrow (go back - but we're at top level, so just refresh)
        local first_line=$(echo "$selected" | head -1)
        [[ "$first_line" == "left" ]] && continue

        selected=$(echo "$selected" | tail -n +2)
        [[ -z "$selected" ]] && exit 0

        # Skip separator lines
        [[ "$selected" == â”â”â”* ]] && continue

        # Handle selection
        case "$selected" in
            "âž• New session")
                read -p "Session name [agents]: " session_name
                session_name="${session_name:-agents}"
                if ! validate_name "$session_name" "session name"; then
                    echo ""
                    read -p "Press Enter to continue..."
                    continue
                fi
                cmd_new "$session_name"
                exit 0
                ;;
            "ðŸ“Š Status"*)
                cmd_status
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "âž• Add panes")
                read -p "How many panes to add? [1]: " count
                count="${count:-1}"
                read -p "Names (space-separated, optional): " -a names
                cmd_add "$count" "${names[@]}"
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "ðŸ“ Layout"*)
                cmd_layout
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "ðŸ·ï¸"*"Rename"*)
                read -p "Pane index to rename: " index
                read -p "New name: " name
                if [[ -n "$index" && -n "$name" ]]; then
                    if validate_name "$name" "pane name"; then
                        cmd_rename "$index" "$name"
                    fi
                fi
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "ðŸŽ¯ Focus"*)
                read -p "Pane index or name to focus: " target
                if [[ -n "$target" ]]; then
                    cmd_focus "$target"
                fi
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "ðŸ“‹ Copy pane")
                cmd_copy
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "ðŸ“œ Copy pane (full history)")
                cmd_copy_full
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "ðŸ“¥ Paste to pane")
                cmd_paste
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "ðŸŒ³ Create worktree")
                cmd_worktree
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "ðŸš€ Delegate tasks")
                cmd_delegate
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "ðŸ“Š All sessions status")
                cmd_status_all
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "âŒ Close"*)
                read -p "Pane index or name to close: " target
                if [[ -n "$target" ]]; then
                    cmd_close "$target"
                fi
                echo ""
                read -p "Press Enter to continue..."
                ;;
            "ðŸ’€ Kill"*)
                echo "Options: session name, pane index, or 'all'"
                read -p "What to kill: " target
                if [[ -n "$target" ]]; then
                    cmd_kill "$target"
                fi
                echo ""
                read -p "Press Enter to continue..."
                ;;
            ðŸŸ¢*|âšª*)
                # Session selected - attach to it
                local session_name
                session_name=$(echo "$selected" | sed 's/^[ðŸŸ¢âšª] //; s/ (.*//')
                tmux attach -t "$session_name"
                exit 0
                ;;
        esac
    done
}

# Open/attach to session (interactive if no name given)
cmd_open() {
    local target="$1"

    # If target specified, attach directly
    if [[ -n "$target" ]]; then
        if tmux has-session -t "$target" 2>/dev/null; then
            tmux attach -t "$target"
        else
            echo -e "${RED}Session '$target' not found.${NC}"
            echo "Available sessions:"
            tmux list-sessions 2>/dev/null || echo "  (none)"
            exit 1
        fi
        return
    fi

    # No target - show interactive menu
    cmd_menu
}

# Create new agent session
cmd_new() {
    local session_name="${1:-agents}"

    if tmux has-session -t "$session_name" 2>/dev/null; then
        echo -e "${YELLOW}Session '$session_name' already exists. Attaching...${NC}"
        tmux attach -t "$session_name"
        return
    fi

    # Require agent-session to be installed
    if ! command -v agent-session &> /dev/null; then
        echo -e "${RED}Error: agent-session not found. Run install.sh first.${NC}"
        exit 1
    fi

    agent-session "$session_name"
}

# Main command router
case "${1:-}" in
    open|o)
        shift
        cmd_open "$@"
        ;;
    new|n)
        shift
        cmd_new "$@"
        ;;
    status|s)
        cmd_status
        ;;
    add|a)
        shift
        cmd_add "$@"
        ;;
    close|c)
        shift
        cmd_close "$@"
        ;;
    kill|k)
        shift
        cmd_kill "$@"
        ;;
    rename|r)
        shift
        cmd_rename "$@"
        ;;
    focus|f)
        shift
        cmd_focus "$@"
        ;;
    copy|cp)
        shift
        cmd_copy "$@"
        ;;
    copy-full|cpf)
        shift
        cmd_copy_full "$@"
        ;;
    paste|p)
        shift
        cmd_paste "$@"
        ;;
    layout|l)
        cmd_layout
        ;;
    list|ls)
        cmd_list
        ;;
    help|--help|-h)
        show_help
        ;;
    "")
        # No command - default to open (interactive session picker)
        cmd_open
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo "Run 'agent-manage help' for usage"
        exit 1
        ;;
esac
