#!/bin/bash
# agent-session - Launch a 3-pane Claude Code agent workflow
# Layout: Plan | Work | Review (three vertical columns)
# Usage: agent-session [options] [session-name] [project-path]

# Colors for error messages
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

show_usage() {
    cat << 'EOF'
agent-session - Launch a 3-pane Claude Code agent workflow

USAGE:
    agent-session [options] [session-name] [project-path]

OPTIONS:
    --task, -t <id>     Create session named "agent-<id>" (for task-based workflows)
    --name, -n <name>   Explicit session name
    --path, -p <path>   Project directory (default: current directory)
    --help, -h          Show this help

EXAMPLES:
    agent-session                    # Creates "agents" session
    agent-session myproject          # Creates "myproject" session
    agent-session --task 42          # Creates "agent-42" session
    agent-session --task auth-fix    # Creates "agent-auth-fix" session
    agent-session -t feat-1 -p ~/code/myapp
EOF
}

# Validate name - alphanumeric, dash, underscore only
validate_name() {
    local name="$1"
    local type="${2:-name}"
    if ! [[ "$name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        echo -e "${RED}Error: Invalid $type. Use only alphanumeric, dash, underscore.${NC}" >&2
        return 1
    fi
    return 0
}

# Parse arguments
SESSION_NAME=""
PROJECT_PATH=""
TASK_ID=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --task|-t)
            TASK_ID="$2"
            shift 2
            ;;
        --name|-n)
            SESSION_NAME="$2"
            shift 2
            ;;
        --path|-p)
            PROJECT_PATH="$2"
            shift 2
            ;;
        --help|-h)
            show_usage
            exit 0
            ;;
        -*)
            echo -e "${RED}Unknown option: $1${NC}"
            show_usage
            exit 1
            ;;
        *)
            # Positional arguments (backward compatible)
            if [ -z "$SESSION_NAME" ]; then
                SESSION_NAME="$1"
            elif [ -z "$PROJECT_PATH" ]; then
                PROJECT_PATH="$1"
            fi
            shift
            ;;
    esac
done

# Apply task ID if provided (overrides session name)
if [ -n "$TASK_ID" ]; then
    validate_name "$TASK_ID" "task ID" || exit 1
    SESSION_NAME="agent-${TASK_ID}"
fi

# Defaults
SESSION_NAME="${SESSION_NAME:-agents}"
validate_name "$SESSION_NAME" "session name" || exit 1

PROJECT_PATH="${PROJECT_PATH:-$(pwd)}"

# Check if session already exists
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "Session '$SESSION_NAME' already exists. Attaching..."
    tmux attach -t "$SESSION_NAME"
    exit 0
fi

# Create new session with first pane (Plan)
tmux new-session -d -s "$SESSION_NAME" -n "agents" -c "$PROJECT_PATH"

# Split horizontally for Work pane (middle)
tmux split-window -h -t "$SESSION_NAME:agents" -c "$PROJECT_PATH"

# Split horizontally again for Review pane (right)
tmux split-window -h -t "$SESSION_NAME:agents" -c "$PROJECT_PATH"

# Even out the three panes (33% each)
tmux select-layout -t "$SESSION_NAME:agents" even-horizontal

# Get actual pane IDs (for setting options)
PANE_IDS=($(tmux list-panes -t "$SESSION_NAME:agents" -F "#{pane_id}"))

# Set role for each pane (shown as prefix in pane border)
# Claude Code will dynamically update pane_title with current task
tmux set-option -p -t "${PANE_IDS[0]}" @role "PLAN"
tmux set-option -p -t "${PANE_IDS[1]}" @role "WORK"
tmux set-option -p -t "${PANE_IDS[2]}" @role "REVIEW"

# Set initial pane title (will be overwritten by Claude Code when it starts)
if [ -n "$TASK_ID" ]; then
    tmux select-pane -t "${PANE_IDS[0]}" -T "$TASK_ID"
    tmux select-pane -t "${PANE_IDS[1]}" -T "$TASK_ID"
    tmux select-pane -t "${PANE_IDS[2]}" -T "$TASK_ID"
else
    tmux select-pane -t "${PANE_IDS[0]}" -T "Ready"
    tmux select-pane -t "${PANE_IDS[1]}" -T "Ready"
    tmux select-pane -t "${PANE_IDS[2]}" -T "Ready"
fi

# Optional: Start Claude Code in each pane
# Uncomment if you want auto-start:
# tmux send-keys -t "${PANE_IDS[0]}" "claude" Enter
# tmux send-keys -t "${PANE_IDS[1]}" "claude" Enter
# tmux send-keys -t "${PANE_IDS[2]}" "claude" Enter

# Focus on Plan pane
tmux select-pane -t "${PANE_IDS[0]}"

# Attach to the session
tmux attach -t "$SESSION_NAME"
