#!/bin/bash
set -e
# agent-session - Launch a 3-pane AI agent workflow
# Layout: Plan | Work | Review (three vertical columns)
# Usage: agent-session [options] [session-name] [project-path]

# Source shared utilities
source "$(dirname "$0")/agent-common.sh"

show_usage() {
    cat << 'EOF'
agent-session - Launch a 3-pane AI agent workflow

USAGE:
    agent-session [options] [session-name] [project-path]

OPTIONS:
    --task, -t <id>     Create session named "agent-<id>" (for task-based workflows)
    --name, -n <name>   Explicit session name
    --path, -p <path>   Project directory (default: current directory)
    --help, -h          Show this help

EXAMPLES:
    agent-session                    # Creates "agents" session
    agent-session myproject          # Creates "myproject" session
    agent-session --task 42          # Creates "agent-42" session
    agent-session --task auth-fix    # Creates "agent-auth-fix" session
    agent-session -t feat-1 -p ~/code/myapp
EOF
}

# Parse arguments
SESSION_NAME=""
PROJECT_PATH=""
TASK_ID=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --task|-t)
            TASK_ID="$2"
            shift 2
            ;;
        --name|-n)
            SESSION_NAME="$2"
            shift 2
            ;;
        --path|-p)
            PROJECT_PATH="$2"
            shift 2
            ;;
        --help|-h)
            show_usage
            exit 0
            ;;
        -*)
            echo -e "${RED}Unknown option: $1${NC}"
            show_usage
            exit 1
            ;;
        *)
            # Positional arguments (backward compatible)
            if [ -z "$SESSION_NAME" ]; then
                SESSION_NAME="$1"
            elif [ -z "$PROJECT_PATH" ]; then
                PROJECT_PATH="$1"
            fi
            shift
            ;;
    esac
done

# Apply task ID if provided (overrides session name)
if [ -n "$TASK_ID" ]; then
    validate_name "$TASK_ID" "task ID" || exit 1
    SESSION_NAME="agent-${TASK_ID}"
fi

# Defaults
SESSION_NAME="${SESSION_NAME:-agents}"
validate_name "$SESSION_NAME" "session name" || exit 1

PROJECT_PATH="${PROJECT_PATH:-$(pwd)}"

# Check if session already exists
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    echo "Session '$SESSION_NAME' already exists. Attaching..."
    tmux attach -t "$SESSION_NAME"
    exit 0
fi

# Create 3-pane session using shared function
create_agent_session "$SESSION_NAME" "$PROJECT_PATH" "${TASK_ID:-Ready}"

# Attach to the session
tmux attach -t "$SESSION_NAME"
