#!/bin/bash
# agent-status - Dashboard view of all agent sessions
# Usage: agent-status [--watch]
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
DIM='\033[2m'
NC='\033[0m'

show_usage() {
    cat << 'EOF'
agent-status - Dashboard view of all agent sessions

USAGE:
    agent-status [options]

OPTIONS:
    --watch, -w       Refresh every 2 seconds
    --all, -a         Show all tmux sessions (not just agent-*)
    --help, -h        Show this help

EXAMPLES:
    agent-status              # One-time status
    agent-status --watch      # Live dashboard
    agent-status --all        # Include non-agent sessions
EOF
}

WATCH_MODE=false
SHOW_ALL=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --watch|-w)
            WATCH_MODE=true
            shift
            ;;
        --all|-a)
            SHOW_ALL=true
            shift
            ;;
        --help|-h)
            show_usage
            exit 0
            ;;
        *)
            shift
            ;;
    esac
done

show_status() {
    clear 2>/dev/null || true

    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}           AGENT STATUS DASHBOARD${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    # Get sessions
    local filter=""
    if [ "$SHOW_ALL" = false ]; then
        filter="^agent"
    fi

    local sessions
    if [ -n "$filter" ]; then
        sessions=$(tmux list-sessions -F "#{session_name}|#{session_windows}|#{session_attached}|#{session_activity}" 2>/dev/null | grep "$filter" || true)
    else
        sessions=$(tmux list-sessions -F "#{session_name}|#{session_windows}|#{session_attached}|#{session_activity}" 2>/dev/null || true)
    fi

    if [ -z "$sessions" ]; then
        if [ "$SHOW_ALL" = false ]; then
            echo -e "${YELLOW}No agent sessions found${NC}"
            echo ""
            echo "Create one with:"
            echo "  agent-session --task <name>"
            echo "  agent-delegate <task1> <task2>"
        else
            echo -e "${YELLOW}No tmux sessions running${NC}"
        fi
        return
    fi

    # Header
    printf "${DIM}%-25s %-8s %-12s %-35s${NC}\n" "SESSION" "PANES" "STATUS" "LAST OUTPUT"
    printf "${DIM}%-25s %-8s %-12s %-35s${NC}\n" "─────────────────────────" "────────" "────────────" "───────────────────────────────────"

    while IFS='|' read -r name windows attached activity; do
        # Get pane count
        local pane_count
        pane_count=$(tmux list-panes -t "$name" 2>/dev/null | wc -l | tr -d ' ')

        # Determine status with icon
        local status
        if [ "$attached" = "1" ]; then
            status="${GREEN}● Active${NC}"
        else
            # Check last activity to determine if waiting
            local now=$(date +%s)
            local idle=$((now - activity))

            if [ $idle -gt 300 ]; then
                status="${CYAN}○ Idle${NC}"
            else
                # Try to detect if waiting for input
                local last_line
                last_line=$(tmux capture-pane -t "$name:0.0" -p 2>/dev/null | grep -v '^$' | tail -1 || true)

                if [[ "$last_line" == *"?"* ]] || [[ "$last_line" == *"> "* ]] || [[ "$last_line" == *"$ "* ]] || [[ "$last_line" == *"❯"* ]]; then
                    status="${YELLOW}◐ Waiting${NC}"
                else
                    status="${CYAN}◑ Running${NC}"
                fi
            fi
        fi

        # Get last output (truncated)
        local last_output
        last_output=$(tmux capture-pane -t "$name:0.0" -p 2>/dev/null | grep -v '^$' | tail -1 | cut -c1-33 || echo "-")
        [ -z "$last_output" ] && last_output="-"

        printf "%-25s %-8s %-12b %-35s\n" "$name" "$pane_count" "$status" "$last_output"
    done <<< "$sessions"

    echo ""

    # Count summary
    local total attached detached
    total=$(echo "$sessions" | wc -l | tr -d ' ')
    attached=$(echo "$sessions" | grep "|1|" | wc -l | tr -d ' ')
    detached=$((total - attached))

    echo -e "${DIM}Total: $total sessions ($attached attached, $detached detached)${NC}"
    echo ""

    # Quick commands
    echo -e "${BLUE}Quick Commands:${NC}"
    echo "  tmux attach -t <session>   Attach to session"
    echo "  agent-manage               Open management menu"
    echo "  agent-delegate <tasks>     Create more sessions"

    if [ "$WATCH_MODE" = true ]; then
        echo ""
        echo -e "${DIM}Refreshing every 2s... Press Ctrl+C to exit${NC}"
    fi
}

if [ "$WATCH_MODE" = true ]; then
    # Watch mode - refresh every 2 seconds
    trap 'echo ""; exit 0' INT
    while true; do
        show_status
        sleep 2
    done
else
    show_status
    # If running in a popup/interactive context, wait for user input
    if [ -t 0 ]; then
        echo ""
        echo -e "${DIM}Press any key to exit...${NC}"
        read -n 1 -s </dev/tty
    fi
fi
