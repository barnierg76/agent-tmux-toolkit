#!/bin/bash
# agent-worktree - Create git worktree + tmux session for parallel agent work
# Usage: agent-worktree <branch-name> [base-branch]
set -e

# Source shared utilities
source "$(dirname "$0")/agent-common.sh"

show_usage() {
    cat << 'EOF'
agent-worktree - Create git worktree + tmux session for parallel work

USAGE:
    agent-worktree <branch-name> [base-branch]

ARGUMENTS:
    branch-name   Name for new branch and session (required)
    base-branch   Branch to create from (default: main)

OPTIONS:
    --list, -l    List existing worktrees
    --remove, -r  Remove worktree and session
    --help, -h    Show this help

EXAMPLES:
    agent-worktree feat-auth              # Branch from main
    agent-worktree feat-api develop       # Branch from develop
    agent-worktree --list                 # Show all worktrees
    agent-worktree --remove feat-auth     # Clean up worktree

WORKFLOW:
    1. Creates git worktree at ../<repo>-<branch>
    2. Creates new branch if it doesn't exist
    3. Launches agent session in worktree directory
    4. Session named "agent-<branch>"
EOF
}

list_worktrees() {
    echo -e "${BLUE}=== Git Worktrees ===${NC}"
    git worktree list
    echo ""
    echo -e "${BLUE}=== Agent Sessions ===${NC}"
    tmux list-sessions 2>/dev/null | grep "^agent-" || echo "No agent sessions"
}

remove_worktree() {
    local branch="$1"
    local repo_name="${PWD##*/}"
    local worktree_dir="../${repo_name}-${branch}"
    local session_name="agent-${branch}"

    # Kill session if exists
    if tmux has-session -t "$session_name" 2>/dev/null; then
        echo -e "${YELLOW}Killing session: $session_name${NC}"
        tmux kill-session -t "$session_name"
    fi

    # Remove worktree if exists
    if [ -d "$worktree_dir" ]; then
        echo -e "${YELLOW}Removing worktree: $worktree_dir${NC}"
        git worktree remove "$worktree_dir" --force
    fi

    echo -e "${GREEN}Cleaned up: $branch${NC}"
}

# Parse arguments
ACTION="create"
BRANCH_NAME=""
BASE_BRANCH="main"

while [[ $# -gt 0 ]]; do
    case $1 in
        --list|-l)
            ACTION="list"
            shift
            ;;
        --remove|-r)
            ACTION="remove"
            BRANCH_NAME="$2"
            shift 2
            ;;
        --help|-h)
            show_usage
            exit 0
            ;;
        -*)
            echo -e "${RED}Unknown option: $1${NC}"
            show_usage
            exit 1
            ;;
        *)
            if [ -z "$BRANCH_NAME" ]; then
                BRANCH_NAME="$1"
            else
                BASE_BRANCH="$1"
            fi
            shift
            ;;
    esac
done

# Handle list action
if [ "$ACTION" = "list" ]; then
    list_worktrees
    exit 0
fi

# Handle remove action
if [ "$ACTION" = "remove" ]; then
    [ -z "$BRANCH_NAME" ] && { echo -e "${RED}Branch name required${NC}"; exit 1; }
    remove_worktree "$BRANCH_NAME"
    exit 0
fi

# Create action requires branch name
[ -z "$BRANCH_NAME" ] && { show_usage; exit 1; }

# Verify git repo
git rev-parse --git-dir &>/dev/null || die "Not a git repository"

# Validate branch name
validate_name "$BRANCH_NAME" "branch name" || exit 1

REPO_NAME="${PWD##*/}"
WORKTREE_DIR="../${REPO_NAME}-${BRANCH_NAME}"
SESSION_NAME="agent-${BRANCH_NAME}"

# Check if worktree already exists
if [ -d "$WORKTREE_DIR" ]; then
    echo -e "${YELLOW}Worktree already exists at $WORKTREE_DIR${NC}"

    # Check if session exists
    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        echo -e "${GREEN}Attaching to existing session: $SESSION_NAME${NC}"
        tmux attach -t "$SESSION_NAME"
    else
        echo -e "${GREEN}Creating session in existing worktree${NC}"
        cd "$WORKTREE_DIR"
        agent-session --task "$BRANCH_NAME"
    fi
    exit 0
fi

# Check if branch exists
if git show-ref --verify --quiet "refs/heads/${BRANCH_NAME}"; then
    echo -e "${YELLOW}Branch '${BRANCH_NAME}' exists, checking out${NC}"
    git worktree add "$WORKTREE_DIR" "$BRANCH_NAME"
else
    echo -e "${GREEN}Creating new branch '${BRANCH_NAME}' from ${BASE_BRANCH}${NC}"

    # Verify base branch exists
    if ! git show-ref --verify --quiet "refs/heads/${BASE_BRANCH}" && \
       ! git show-ref --verify --quiet "refs/remotes/origin/${BASE_BRANCH}"; then
        echo -e "${RED}Error: Base branch '${BASE_BRANCH}' not found${NC}"
        exit 1
    fi

    git worktree add -b "$BRANCH_NAME" "$WORKTREE_DIR" "$BASE_BRANCH"
fi

echo -e "${GREEN}Worktree created at: $WORKTREE_DIR${NC}"

# Create tmux session in worktree
cd "$WORKTREE_DIR"
echo -e "${GREEN}Starting agent session: $SESSION_NAME${NC}"

# Use agent-session with --task flag (which won't attach if we want to show info first)
# Instead, we'll create detached and then attach
AGENT_SESSION_PATH="$(which agent-session 2>/dev/null || echo "$HOME/.local/bin/agent-session")"

if [ -x "$AGENT_SESSION_PATH" ]; then
    # Create session (agent-session will attach)
    "$AGENT_SESSION_PATH" --task "$BRANCH_NAME"
else
    # Fallback if agent-session not in PATH yet
    create_agent_session "$SESSION_NAME" "$WORKTREE_DIR" "$BRANCH_NAME"
    tmux attach -t "$SESSION_NAME"
fi
