#!/bin/bash
# snippet-picker - Quick snippet selection for Claude Code agents
# Usage: Called from tmux popup, sends selected snippet to active pane
# Supports folders via # ═══ FOLDER ═══ headers in snippets file
# Pane-aware: Shows relevant folders first based on current pane (PLAN/WORK/REVIEW)

# Source shared utilities
source "$(dirname "$0")/agent-common.sh"

SNIPPETS_FILE="${HOME}/.config/agent-snippets/snippets.txt"

# Single tmux call to get all pane info at once (performance optimization)
IFS='|' read -r TARGET_PANE PANE_ROLE PANE_TITLE <<< "$(tmux display-message -p '#{pane_id}|#{@role}|#{pane_title}' 2>/dev/null)"

# Detect pane context from role or title
detect_pane_context() {
    if [[ -n "$PANE_ROLE" ]]; then
        echo "$PANE_ROLE"
        return
    fi
    case "$PANE_TITLE" in
        PLAN*)   echo "PLAN" ;;
        WORK*)   echo "WORK" ;;
        REVIEW*) echo "REVIEW" ;;
        *)       echo "" ;;
    esac
}

# Get folder filter pattern based on pane context
get_pane_folder_filter() {
    case "$1" in
        PLAN)   echo "^(PLAN|EVERY|HANDOFF)" ;;
        WORK)   echo "^(WORK|EVERY|QUICK)" ;;
        REVIEW) echo "^(REVIEW|EVERY)" ;;
        *)      echo "" ;;
    esac
}

CURRENT_PANE=$(detect_pane_context)
PANE_FILTER=$(get_pane_folder_filter "$CURRENT_PANE")

# Check dependencies
if [[ ! -f "$SNIPPETS_FILE" ]]; then
    echo "No snippets file found at $SNIPPETS_FILE"
    echo "Press any key to exit..."
    read -n 1
    exit 1
fi

check_fzf  # From shared library

# Parse snippets with folder information (cached for performance)
# Output: FOLDER/Label\tContent
PARSED_SNIPPETS=$(awk '
    BEGIN { folder="General"; label=""; content="" }
    /^# ═══.*═══/ {
        folder = $0
        sub(/^# ═══ /, "", folder)
        sub(/ ═══.*$/, "", folder)
        next
    }
    /^#/ { next }
    /^[[:space:]]*$/ { next }
    /^---/ {
        if (label != "" && content != "") {
            gsub(/\n/, "\\n", content)
            print folder "/" label "\t" content
        }
        label = ""
        content = ""
        next
    }
    label == "" { label = $0; next }
    {
        if (content == "") content = $0
        else content = content "\n" $0
    }
    END {
        if (label != "" && content != "") {
            gsub(/\n/, "\\n", content)
            print folder "/" label "\t" content
        }
    }
' "$SNIPPETS_FILE")

# Get workflow suggestion if available
WORKFLOW_SUGGESTION=""
if command -v agent-flow-state &>/dev/null; then
    WORKFLOW_SUGGESTION=$(agent-flow-state suggest 2>/dev/null || true)
fi

# Main navigation loop
while true; do
    # Build folder list - relevant folders first (single awk pass for performance)
    folder_list=$(echo "$PARSED_SNIPPETS" | cut -d'/' -f1 | sort -u | awk -v filter="$PANE_FILTER" '
        {
            if (filter != "" && $0 ~ filter) {
                relevant[++r] = $0
            } else {
                other[++o] = $0
            }
        }
        END {
            # Print relevant folders first
            for (i = 1; i <= r; i++) print relevant[i]
            # Then other folders
            for (i = 1; i <= o; i++) print other[i]
        }
    ')

    # Build header
    header="Select folder (<- cancel, ? help, ESC quit)"
    [[ -n "$CURRENT_PANE" ]] && header="[$CURRENT_PANE] $header"
    [[ -n "$WORKFLOW_SUGGESTION" ]] && header="$header | $WORKFLOW_SUGGESTION"

    # Show folder selection
    selected_folder=$(echo "$folder_list" | fzf \
        --height=100% \
        --layout=reverse \
        --border=rounded \
        --prompt="${CURRENT_PANE:+[$CURRENT_PANE] }> " \
        --header="$header" \
        --no-preview \
        --bind='left:abort' \
        --bind='?:execute(~/.local/bin/agent-help)' \
        --expect='left')

    # Handle navigation
    first_line=$(echo "$selected_folder" | head -1)
    [[ -z "$selected_folder" ]] && exit 0  # ESC
    [[ "$first_line" == "left" ]] && exit 0  # Left arrow

    # Extract folder selection
    selected_folder=$(echo "$selected_folder" | tail -n +2)
    [[ -z "$selected_folder" ]] && exit 0

    # Filter snippets by folder
    snippets=$(echo "$PARSED_SNIPPETS" | grep "^${selected_folder}/")

    # Show snippets
    selected=$(echo "$snippets" | fzf \
        --height=100% \
        --layout=reverse \
        --border=rounded \
        --prompt="${selected_folder}> " \
        --header="Select snippet (<- back, ? help, ESC quit)" \
        --delimiter=$'\t' \
        --with-nth=1 \
        --preview='echo {2} | sed "s/\\\\n/\n/g"' \
        --preview-window=down:4:wrap \
        --bind='left:abort' \
        --bind='?:execute(~/.local/bin/agent-help)' \
        --expect='left')

    # Handle navigation
    first_line=$(echo "$selected" | head -1)
    if [[ "$first_line" == "left" ]]; then
        continue  # Go back to folders
    fi
    [[ -z "$selected" ]] && exit 0  # ESC

    # Extract selection
    selected=$(echo "$selected" | tail -n +2)
    [[ -z "$selected" ]] && continue

    # Extract content and send to pane
    text=$(echo "$selected" | cut -f2)
    text=$(echo "$text" | sed 's/\\n/\n/g')

    tmux send-keys -t "$TARGET_PANE" "$text"
    exit 0
done
